// schema.prisma — Optimized for analytics & performance (PostgreSQL)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

/* =========================
   Enums
========================= */
enum UserRole {
  USER
  ORGANIZER
  ADMIN
}

enum PlanTier {
  FREE
  PRO
  ENTERPRISE
}

/* =========================
   Users & Roles
========================= */
model User {
  id           String   @id @default(cuid())
  email        String   @unique @db.Citext
  name         String   @db.VarChar(120)
  passwordHash String   @db.VarChar(200)
  role         UserRole @default(USER)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  claims     Claim[]
  activities UserActivity[]

  @@map("users")

  // Indexes for auth & listing
  @@index([createdAt])
  @@index([isActive])
}

/* =========================
   Organizers & API Keys
========================= */
model Organizer {
  id           String    @id @default(cuid())
  email        String    @unique @db.Citext
  name         String    @db.VarChar(120)
  company      String?   @db.VarChar(160)
  passwordHash String    @db.VarChar(200)
  isActive     Boolean   @default(true)
  tier         PlanTier  @default(FREE)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  apiKeys   ApiKey[]
  campaigns Campaign[]

  @@map("organizers")

  @@index([createdAt])
  @@index([isActive, tier])
}

model ApiKey {
  id          String   @id @default(cuid())
  key         String   @unique @db.VarChar(80)
  name        String   @db.VarChar(120)
  organizerId String
  isActive    Boolean  @default(true)
  lastUsedAt  DateTime?
  createdAt   DateTime @default(now())

  // Relations
  organizer Organizer @relation(fields: [organizerId], references: [id], onDelete: Cascade)

  @@map("api_keys")

  // For quick scans by org & status
  @@index([organizerId])
  @@index([isActive])
  @@index([lastUsedAt])
}

/* =========================
   Campaigns
========================= */
model Campaign {
  id          String   @id @default(cuid())
  name        String   @db.VarChar(200)
  description String?
  eventDate   DateTime
  location    String?  @db.VarChar(200)
  imageUrl    String?  @db.VarChar(600)
  externalUrl String?  @db.VarChar(600)
  // Actual en uso (texto plano). Mantener por compatibilidad:
  secretCode  String?  @db.VarChar(120)
  // Futuro seguro (hash del código). Úsalo cuando migres la verificación:
  secretCodeHash String? @db.VarChar(200)

  maxClaims   Int?
  isActive    Boolean  @default(true)
  organizerId String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Metadata
  metadata Json?

  // Relations
  organizer Organizer @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  claims    Claim[]

  @@map("campaigns")

  // Indexes used by analytics & listing
  @@index([organizerId])
  @@index([createdAt])
  @@index([organizerId, isActive])
  @@index([eventDate])
}

/* =========================
   Claims & Usage
========================= */
model Claim {
  id              String   @id @default(cuid())
  campaignId      String
  userId          String?
  userPublicKey   String   @db.VarChar(100)
  mintAddress     String?  @db.VarChar(100)
  tokenAccount    String?  @db.VarChar(100)
  transactionHash String?  @db.VarChar(140)
  gasCost         Int?
  claimedAt       DateTime @default(now())

  // Extra data
  userAgent String?
  ipAddress String? @db.VarChar(64)
  metadata  Json?

  // Relations
  campaign Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  user     User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Prevent duplicate claims per campaign/user
  @@unique([campaignId, userPublicKey])

  @@map("claims")

  // Indexes — KEY for analytics & lookups
  @@index([claimedAt])
  @@index([campaignId, claimedAt])
  @@index([userPublicKey, claimedAt])
}

model Usage {
  id          String   @id @default(cuid())
  organizerId String
  date        DateTime @default(now()) // si quieres unicidad por día, guarda truncado
  claims      Int      @default(0)
  gasCost     Int      @default(0)

  @@unique([organizerId, date])
  @@map("usage")

  @@index([date])
  @@index([organizerId, date])
}

/* =========================
   NFT Mints, Relayer Stats, Activity
========================= */
model NFTMint {
  id                   String   @id @default(cuid())
  mintAddress          String   @unique @db.VarChar(100)
  userPublicKey        String   @db.VarChar(100)
  transactionSignature String   @unique @db.VarChar(140)
  metadata             Json
  gasCost              Int
  relayerPublicKey     String   @db.VarChar(100)
  serviceId            String?  @db.VarChar(120)
  eventId              String?  @db.VarChar(120)
  eventName            String?  @db.VarChar(200)
  network              String   @default("devnet") @db.VarChar(32)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@map("nft_mints")

  // For explorers & dashboards
  @@index([userPublicKey, createdAt])
  @@index([createdAt])
  @@index([relayerPublicKey, createdAt])
}

model RelayerStats {
  id               String   @id @default(cuid())
  relayerPublicKey String   @unique @db.VarChar(100)
  totalMints       Int      @default(0)
  totalGasPaid     BigInt   @default(0)
  currentBalance   BigInt   @default(0)
  lastActivity     DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@map("relayer_stats")

  @@index([lastActivity])
}

model UserActivity {
  id            String   @id @default(cuid())
  userPublicKey String   @db.VarChar(100)
  action        String   @db.VarChar(60) // "mint_nft", "claim_poap", etc.
  details       Json
  ipAddress     String?  @db.VarChar(64)
  userAgent     String?
  createdAt     DateTime @default(now())

  // Reverse relation to User
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_activity")

  @@index([userId, createdAt])
  @@index([userPublicKey, createdAt])
}
